{% extends "base.html" %}

{% block title %}Cadastro - FovDark{% endblock %}

{% block body_class %}auth-page{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-form-wrapper">
        <div class="auth-form">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-shield-alt"></i>
                    <h1>FovDark</h1>
                </div>
                <h2>Criar Conta</h2>
                <p>Junte-se a milhares de usuários satisfeitos</p>
            </div>

            <form action="/register" method="POST" class="register-form" id="registerForm">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user"></i>
                        Usuário
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="form-control"
                        placeholder="Escolha um nome de usuário"
                        required
                        autocomplete="username"
                        pattern="^[a-zA-Z0-9_-]{3,30}$"
                    >
                    <div class="form-help">3-30 caracteres, apenas letras, números, _ e -</div>
                    <div class="form-error" id="username-error"></div>
                </div>

                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-control"
                        placeholder="Digite seu melhor email"
                        required
                        autocomplete="email"
                    >
                    <div class="form-help">Usado para recuperação de senha e notificações</div>
                    <div class="form-error" id="email-error"></div>
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        Senha
                    </label>
                    <div class="password-input">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-control"
                            placeholder="Crie uma senha forte"
                            required
                            autocomplete="new-password"
                            minlength="8"
                        >
                        <button type="button" class="password-toggle" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text">Digite uma senha</div>
                    </div>
                    <div class="form-error" id="password-error"></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">
                        <i class="fas fa-lock"></i>
                        Confirmar Senha
                    </label>
                    <div class="password-input">
                        <input 
                            type="password" 
                            id="confirm_password" 
                            name="confirm_password" 
                            class="form-control"
                            placeholder="Digite a senha novamente"
                            required
                            autocomplete="new-password"
                        >
                        <button type="button" class="password-toggle" id="toggleConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="form-error" id="confirm_password-error"></div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="terms" name="terms" required>
                        <span class="checkmark"></span>
                        Concordo com os <a href="/terms" target="_blank">Termos de Uso</a> e <a href="/privacy" target="_blank">Política de Privacidade</a>
                    </label>
                    <div class="form-error" id="terms-error"></div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="newsletter" name="newsletter">
                        <span class="checkmark"></span>
                        Quero receber novidades e promoções por email
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-lg btn-block" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    <span class="btn-text">Criar Conta</span>
                    <span class="btn-loader" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        Criando conta...
                    </span>
                </button>
            </form>

            <div class="auth-divider">
                <span>ou</span>
            </div>

            <div class="auth-links">
                <p>Já tem uma conta?</p>
                <a href="/login" class="btn btn-outline btn-lg btn-block">
                    <i class="fas fa-sign-in-alt"></i>
                    Fazer Login
                </a>
            </div>

            <div class="auth-features">
                <div class="feature-item">
                    <i class="fas fa-gift"></i>
                    <span>Cadastro Gratuito</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-download"></i>
                    <span>Downloads Ilimitados</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-headset"></i>
                    <span>Suporte Premium</span>
                </div>
            </div>
        </div>

        <div class="auth-info">
            <div class="info-content">
                <h3>Comece sua jornada!</h3>
                <p>Ao criar sua conta, você terá acesso a:</p>
                
                <ul class="info-list">
                    <li>
                        <i class="fas fa-compact-disc"></i>
                        ISOs customizadas premium
                    </li>
                    <li>
                        <i class="fas fa-rocket"></i>
                        Otimizadores de sistema
                    </li>
                    <li>
                        <i class="fas fa-gamepad"></i>
                        Cheats e trainers exclusivos
                    </li>
                    <li>
                        <i class="fas fa-puzzle-piece"></i>
                        Mods únicos e atualizados
                    </li>
                    <li>
                        <i class="fas fa-shield-check"></i>
                        Licenças seguras e protegidas
                    </li>
                </ul>

                <div class="info-testimonial">
                    <div class="testimonial-content">
                        <p>"Melhor plataforma de licenças digitais que já usei. Produtos sempre funcionando!"</p>
                    </div>
                    <div class="testimonial-author">
                        <div class="author-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="author-info">
                            <span class="name">João Silva</span>
                            <div class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const strengthMeter = document.getElementById('passwordStrength');

    // Password toggle functionality
    togglePassword.addEventListener('click', function() {
        togglePasswordVisibility(passwordInput, this);
    });

    toggleConfirmPassword.addEventListener('click', function() {
        togglePasswordVisibility(confirmPasswordInput, this);
    });

    function togglePasswordVisibility(input, button) {
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        
        const icon = button.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    }

    // Password strength checker
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        checkPasswordStrength(password);
        
        // Real-time validation
        if (password) {
            validatePassword(password);
        }
        
        // Check confirm password match
        if (confirmPasswordInput.value) {
            validatePasswordMatch();
        }
    });

    confirmPasswordInput.addEventListener('input', function() {
        validatePasswordMatch();
    });

    function checkPasswordStrength(password) {
        const strengthFill = strengthMeter.querySelector('.strength-fill');
        const strengthText = strengthMeter.querySelector('.strength-text');
        
        let score = 0;
        let feedback = [];

        if (password.length >= 8) score++;
        else feedback.push('pelo menos 8 caracteres');

        if (/[a-z]/.test(password)) score++;
        else feedback.push('letra minúscula');

        if (/[A-Z]/.test(password)) score++;
        else feedback.push('letra maiúscula');

        if (/[0-9]/.test(password)) score++;
        else feedback.push('número');

        if (/[^A-Za-z0-9]/.test(password)) score++;
        else feedback.push('caractere especial');

        // Update strength bar
        const percentage = (score / 5) * 100;
        strengthFill.style.width = percentage + '%';

        // Update color and text
        if (score === 0) {
            strengthFill.className = 'strength-fill';
            strengthText.textContent = 'Digite uma senha';
        } else if (score <= 2) {
            strengthFill.className = 'strength-fill weak';
            strengthText.textContent = 'Fraca - adicione: ' + feedback.slice(0, 2).join(', ');
        } else if (score <= 3) {
            strengthFill.className = 'strength-fill medium';
            strengthText.textContent = 'Média - adicione: ' + feedback.slice(0, 1).join(', ');
        } else if (score <= 4) {
            strengthFill.className = 'strength-fill strong';
            strengthText.textContent = 'Forte - quase lá!';
        } else {
            strengthFill.className = 'strength-fill very-strong';
            strengthText.textContent = 'Muito forte!';
        }
    }

    // Form validation
    function validateForm() {
        let isValid = true;
        
        // Clear previous errors
        clearAllErrors();

        // Validate username
        const username = document.getElementById('username').value.trim();
        if (!validateUsername(username)) isValid = false;

        // Validate email
        const email = document.getElementById('email').value.trim();
        if (!validateEmail(email)) isValid = false;

        // Validate password
        const password = passwordInput.value;
        if (!validatePassword(password)) isValid = false;

        // Validate password match
        if (!validatePasswordMatch()) isValid = false;

        // Validate terms
        const terms = document.getElementById('terms').checked;
        if (!terms) {
            showFieldError('terms', 'Você deve aceitar os termos de uso');
            isValid = false;
        }

        return isValid;
    }

    function validateUsername(username) {
        if (!username) {
            showFieldError('username', 'Nome de usuário é obrigatório');
            return false;
        }
        
        if (username.length < 3) {
            showFieldError('username', 'Nome de usuário deve ter pelo menos 3 caracteres');
            return false;
        }
        
        if (username.length > 30) {
            showFieldError('username', 'Nome de usuário deve ter no máximo 30 caracteres');
            return false;
        }
        
        if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
            showFieldError('username', 'Apenas letras, números, _ e - são permitidos');
            return false;
        }
        
        return true;
    }

    function validateEmail(email) {
        if (!email) {
            showFieldError('email', 'Email é obrigatório');
            return false;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showFieldError('email', 'Digite um email válido');
            return false;
        }
        
        return true;
    }

    function validatePassword(password) {
        if (!password) {
            showFieldError('password', 'Senha é obrigatória');
            return false;
        }
        
        if (password.length < 8) {
            showFieldError('password', 'Senha deve ter pelo menos 8 caracteres');
            return false;
        }
        
        return true;
    }

    function validatePasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword && password !== confirmPassword) {
            showFieldError('confirm_password', 'As senhas não coincidem');
            return false;
        }
        
        if (confirmPassword) {
            clearFieldError('confirm_password');
        }
        
        return true;
    }

    function showFieldError(fieldName, message) {
        const field = document.getElementById(fieldName);
        const errorDiv = document.getElementById(fieldName + '-error');
        
        if (field) field.classList.add('error');
        if (errorDiv) errorDiv.textContent = message;
    }

    function clearFieldError(fieldName) {
        const field = document.getElementById(fieldName);
        const errorDiv = document.getElementById(fieldName + '-error');
        
        if (field) field.classList.remove('error');
        if (errorDiv) errorDiv.textContent = '';
    }

    function clearAllErrors() {
        document.querySelectorAll('.form-error').forEach(error => error.textContent = '');
        document.querySelectorAll('.form-control').forEach(input => input.classList.remove('error'));
    }

    // Real-time validation
    document.getElementById('username').addEventListener('blur', function() {
        validateUsername(this.value.trim());
    });

    document.getElementById('email').addEventListener('blur', function() {
        validateEmail(this.value.trim());
    });

    // Form submission
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        // Show loading state
        const btnText = registerBtn.querySelector('.btn-text');
        const btnLoader = registerBtn.querySelector('.btn-loader');
        
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline-flex';
        registerBtn.disabled = true;

        // Submit form
        const formData = new FormData(registerForm);
        
        fetch('/register', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                // Registration successful, redirect
                window.location.href = response.url;
                return;
            }
            return response.text();
        })
        .then(html => {
            if (html) {
                // Registration failed, show error
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const errorAlert = doc.querySelector('.alert-error');
                
                if (errorAlert) {
                    showToast(errorAlert.textContent.trim(), 'error');
                } else {
                    // Check for success message
                    const successAlert = doc.querySelector('.alert-success');
                    if (successAlert) {
                        showToast(successAlert.textContent.trim(), 'success');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Registration error:', error);
            showToast('Erro interno do servidor', 'error');
        })
        .finally(() => {
            // Reset button state
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
            registerBtn.disabled = false;
        });
    });

    // Auto-focus first input
    document.getElementById('username').focus();
});
</script>
{% endblock %}
